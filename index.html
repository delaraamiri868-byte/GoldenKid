<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gold Markup Calculator + Auto Spot & FX</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Gold Calc">
<style>
  :root { --gap: 12px; --pad: 14px; --radius: 12px; }
  body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; background:#0b0c10; color:#e9eef2; }
  .wrap { max-width: 820px; margin: 24px auto; padding: 0 16px; }
  .card { background:#14161a; border:1px solid #262932; border-radius: var(--radius); padding: var(--pad); }
  h1 { font-size: 1.35rem; margin: 0 0 12px; }
  .grid { display: grid; grid-template-columns: 1fr; gap: var(--gap); }
  @media (min-width: 780px){ .grid { grid-template-columns: 1fr 1fr; } }
  label { font-size: 0.95rem; color:#b9c2cc; display:block; margin-bottom: 6px; }
  input, select, button { width: 100%; box-sizing: border-box; padding: 10px 12px; background:#0f1115; border:1px solid #303545; color:#e9eef2; border-radius: 10px; }
  input[type="checkbox"] { width:auto; transform: scale(1.2); margin-right:8px; }
  .row { display:flex; align-items:center; gap:8px; }
  .muted { color:#8e99a7; font-size: 0.9rem; }
  .out { background:#0f1115; border:1px dashed #303545; border-radius: var(--radius); padding: var(--pad); }
  .kpis { display:grid; grid-template-columns: 1fr; gap: var(--gap); }
  @media (min-width: 780px){ .kpis { grid-template-columns: repeat(3, 1fr); } }
  .kpi { background:#14161a; border:1px solid #262932; border-radius: var(--radius); padding: var(--pad); }
  .kpi .label { color:#8e99a7; font-size:0.85rem; }
  .kpi .value { font-size:1.15rem; margin-top:6px; }
  .verdict { font-weight:600; }
  .good { color:#3ddc91; }
  .ok { color:#ffd166; }
  .bad { color:#ff6b6b; }
  .footer { margin-top: 10px; font-size: 0.85rem; color:#7e8896; }
  .inline { display:inline-block; margin-left:6px; }
  .toprow { display: grid; grid-template-columns: 1fr; gap: var(--gap); }
  @media (min-width:780px){ .toprow { grid-template-columns: 1fr 1fr; } }
  .btn { cursor:pointer; }
  .source { font-size: 0.8rem; color:#95a2b1; margin-top:6px; }
  .badge { display:inline-block; padding:2px 8px; border:1px solid #303545; border-radius:999px; font-size:0.8rem; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Gold Markup Calculator</h1>
      <div class="toprow">
        <div class="row" style="gap:10px;">
          <div style="flex:1">
            <label>Currency</label>
            <select id="currency">
              <option value="JPY" selected>JPY (¥)</option>
              <option value="USD">USD ($)</option>
            </select>
          </div>
          <div style="flex:2">
            <label class="row" style="justify-content:space-between; margin:0">
              <span>Auto‑update 24k spot (per gram)</span>
              <span class="badge" id="lastUpdated">—</span>
            </label>
            <div class="row">
              <input type="checkbox" id="autoSpot" checked />
              <label for="autoSpot" class="inline">Auto‑update daily</label>
              <button id="refresh" class="btn" style="max-width:180px;">Refresh now</button>
            </div>
            <div class="source">Sources: metals.live (XAU/oz), exchangerate.host (USD↔JPY). Cache: 24h.</div>
          </div>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="grid">
        <div>
          <label>Weight (grams)</label>
          <input id="weight" inputmode="decimal" placeholder="e.g., 12.4" />
        </div>
        <div>
          <label>Karat</label>
          <div class="row">
            <select id="karat">
              <option value="24">24k (999)</option>
              <option value="22">22k (916)</option>
              <option value="21">21k (875)</option>
              <option value="20">20k (833)</option>
              <option value="18" selected>18k (750)</option>
              <option value="14">14k (585)</option>
              <option value="10">10k (417)</option>
              <option value="custom">Custom…</option>
            </select>
            <input id="karatCustom" inputmode="numeric" placeholder="Custom K (1–24)" style="display:none; width: 120px;" />
          </div>
          <div class="muted">Pure gold grams = Weight × (K / 24)</div>
        </div>
        <div>
          <label>Spot price (24k per gram)</label>
          <input id="spot" inputmode="decimal" placeholder="e.g., 13200" />
          <div class="muted">Auto or manual. Also shows 18k derived price below.</div>
          <div id="derived18k" class="muted">18k ≈ — / g</div>
        </div>
        <div>
          <label>Shop price</label>
          <input id="shop" inputmode="decimal" placeholder="e.g., 198000" />
          <div class="row muted">
            <input type="checkbox" id="inclTax" checked />
            <label for="inclTax" class="inline">Shop price includes tax</label>
          </div>
          <div id="taxBox">
            <label>Tax rate</label>
            <input id="tax" inputmode="decimal" value="0.10" />
            <div class="muted">Japan consumption tax is 10% (0.10).</div>
          </div>
        </div>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="out">
      <div class="kpis">
        <div class="kpi">
          <div class="label">Pure gold (g)</div>
          <div class="value" id="pure">—</div>
        </div>
        <div class="kpi">
          <div class="label">Melt value</div>
          <div class="value" id="melt">—</div>
        </div>
        <div class="kpi">
          <div class="label">Pre‑tax shop price</div>
          <div class="value" id="pretax">—</div>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="kpis">
        <div class="kpi">
          <div class="label">Markup fee</div>
          <div class="value" id="fee">—</div>
        </div>
        <div class="kpi">
          <div class="label">Markup %</div>
          <div class="value" id="pct">—</div>
        </div>
        <div class="kpi">
          <div class="label">Verdict</div>
          <div class="value verdict" id="verdict">—</div>
        </div>
      </div>
    </div>

    <div class="footer">
      Tip: For near‑melt hunting, simple chains (curb/rope) at ≤15% markup are fantastic; 15–30% is fair; >30% means you’re paying more for retail/design.
    </div>
  </div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const weight = $('weight'), karat = $('karat'), karatCustom = $('karatCustom'),
        spot = $('spot'), shop = $('shop'), inclTax = $('inclTax'), tax = $('tax'),
        currency = $('currency'), autoSpot = $('autoSpot'), refreshBtn = $('refresh'),
        derived18k = $('derived18k'), lastUpdated = $('lastUpdated');
  const pure = $('pure'), melt = $('melt'), pretax = $('pretax'),
        fee = $('fee'), pct = $('pct'), verdict = $('verdict');

  // Formatting helpers
  const JPY = new Intl.NumberFormat('ja-JP', { style:'currency', currency:'JPY', maximumFractionDigits:0 });
  const USD = new Intl.NumberFormat('en-US', { style:'currency', currency:'USD', maximumFractionDigits:2 });
  const fmtNum = n => isFinite(n) ? n.toLocaleString(undefined, { maximumFractionDigits:3 }) : '—';
  const parseNum = el => {
    const v = (el.value || '').toString().replace(/,/g,'').trim();
    return v ? Number(v) : NaN;
  };
  const currencySymbol = () => currency.value === 'JPY' ? '¥' : '$';
  const fmtMoney = (n) => {
    if (!isFinite(n)) return '—';
    return currency.value === 'JPY' ? JPY.format(n) : USD.format(n);
  };

  // State for FX & spot
  let fxUSDJPY = NaN;  // JPY per USD
  let spotUSDPerOz = NaN; // USD per troy ounce (XAU)
  const OZ_TO_G = 31.1034768;

  // Cache management
  const storage = {
    load(key){ try { return JSON.parse(localStorage.getItem(key) || ''); } catch(e){ return null; } },
    save(key, val){ try { localStorage.setItem(key, JSON.stringify(val)); } catch(e){} }
  };

  function effectiveKarat(){
    if (karat.value === 'custom') {
      const k = parseNum(karatCustom);
      return (k >= 1 && k <= 24) ? k : NaN;
    }
    return Number(karat.value);
  }

  function updateDerived18k(){
    const P = parseNum(spot);
    if (isFinite(P)) {
      const p18 = P * 0.75;
      derived18k.textContent = `18k ≈ ${currencySymbol()}${(currency.value==='JPY'?Math.round(p18).toLocaleString():p18.toFixed(2))} / g`;
    } else {
      derived18k.textContent = '18k ≈ — / g';
    }
  }

  function updateCalc(){
    const W = parseNum(weight);
    const K = effectiveKarat();
    const P = parseNum(spot);
    const S = parseNum(shop);
    const taxRate = parseNum(tax);

    karatCustom.style.display = (karat.value === 'custom') ? 'block' : 'none';
    $('taxBox').style.display = inclTax.checked ? 'block' : 'none';

    // Guard rails
    if (!isFinite(W) || !isFinite(K) || !isFinite(P) || !isFinite(S) || K <= 0 || K > 24 || W <= 0 || P <= 0 || S <= 0) {
      pure.textContent = melt.textContent = pretax.textContent = fee.textContent = pct.textContent = verdict.textContent = '—';
      verdict.className = 'value verdict';
      updateDerived18k();
      return;
    }

    const pureGold = W * (K / 24);
    const meltValue = pureGold * P;
    const preTax = inclTax.checked && isFinite(taxRate) && taxRate >= 0 ? (S / (1 + taxRate)) : S;
    const markupFee = preTax - meltValue;
    const markupPct = meltValue > 0 ? (markupFee / meltValue) * 100 : NaN;

    pure.textContent = fmtNum(pureGold);
    melt.textContent = fmtMoney(meltValue);
    pretax.textContent = fmtMoney(preTax);
    fee.textContent = fmtMoney(markupFee);
    pct.textContent = isFinite(markupPct) ? `${markupPct.toFixed(1)}%` : '—';

    // Verdict coloring
    verdict.className = 'value verdict';
    if (!isFinite(markupPct)) { verdict.textContent = '—'; return; }
    if (markupPct <= 15) { verdict.textContent = 'Near‑melt (great)'; verdict.classList.add('good'); }
    else if (markupPct <= 30) { verdict.textContent = 'Fair'; verdict.classList.add('ok'); }
    else { verdict.textContent = 'Retail‑heavy'; verdict.classList.add('bad'); }

    updateDerived18k();
  }

  // Persist inputs
  const fields = {weight, karat, karatCustom, spot, shop, inclTax, tax, currency, autoSpot};
  function save(){ 
    const data = {};
    Object.entries(fields).forEach(([k, el]) => data[k] = (el.type === 'checkbox') ? el.checked : el.value);
    storage.save('goldCalc2', data);
  }
  function load(){
    const data = storage.load('goldCalc2') || {};
    Object.entries(fields).forEach(([k, el]) => {
      if (data[k] !== undefined) {
        if (el.type === 'checkbox') el.checked = !!data[k];
        else el.value = data[k];
      }
    });
  }

  // Fetchers
  async function fetchFX(){
    // Try load cache (24h)
    const cached = storage.load('fxUSDJPY');
    const now = Date.now();
    if (cached && (now - cached.t) < 24*60*60*1000 && isFinite(cached.v)) {
      fxUSDJPY = cached.v;
      return fxUSDJPY;
    }
    // exchangerate.host
    try {
      const r = await fetch('https://api.exchangerate.host/latest?base=USD&symbols=JPY');
      const j = await r.json();
      const v = j && j.rates && j.rates.JPY;
      if (isFinite(v)) {
        fxUSDJPY = v;
        storage.save('fxUSDJPY', { t: now, v });
        return v;
      }
    } catch(e){}
    return NaN;
  }

  async function fetchGoldUSDPerOz(){
    // Cache 24h
    const cached = storage.load('spotUSDPerOz');
    const now = Date.now();
    if (cached && (now - cached.t) < 24*60*60*1000 && isFinite(cached.v)) {
      spotUSDPerOz = cached.v;
      lastUpdated.textContent = new Date(cached.t).toLocaleString();
      return spotUSDPerOz;
    }
    // metals.live
    try {
      const r = await fetch('https://api.metals.live/v1/spot/gold');
      const j = await r.json();
      // API returns an array of numbers or objects; pick last number
      let v = Array.isArray(j) ? j[j.length-1] : null;
      if (typeof v === 'object' && v !== null) {
        // Sometimes returns [{gold: 2312.34}] etc.
        const key = Object.keys(v)[0];
        v = v[key];
      }
      if (isFinite(v)) {
        spotUSDPerOz = v;
        storage.save('spotUSDPerOz', { t: now, v });
        lastUpdated.textContent = new Date(now).toLocaleString();
        return v;
      }
    } catch(e){}
    // Fallback: goldprice endpoint (USD/oz)
    try {
      const r = await fetch('https://data-asg.goldprice.org/dbXRates/USD');
      const j = await r.json();
      // structure: j.items[0].xauPrice
      const v = j && j.items && j.items[0] && Number(j.items[0].xauPrice);
      if (isFinite(v)) {
        spotUSDPerOz = v;
        storage.save('spotUSDPerOz', { t: now, v });
        lastUpdated.textContent = new Date(now).toLocaleString();
        return v;
      }
    } catch(e){}
    return NaN;
  }

  async function updateSpotFromInternet(force=false){
    if (!autoSpot.checked && !force) return;
    lastUpdated.textContent = 'Updating…';
    const [fx, oz] = await Promise.all([fetchFX(), fetchGoldUSDPerOz()]);
    if (!isFinite(fx) || !isFinite(oz)) {
      lastUpdated.textContent = 'Failed';
      return;
    }
    // USD/oz -> USD/g
    const usdPerG = oz / OZ_TO_G;
    const cur = currency.value;
    let p;
    if (cur === 'JPY') {
      p = usdPerG * fx;
    } else {
      p = usdPerG;
    }
    spot.value = cur === 'JPY' ? Math.round(p).toString() : p.toFixed(2);
    updateDerived18k();
    updateCalc();
    // set lastUpdated from cached timestamp
    const cached = storage.load('spotUSDPerOz');
    if (cached) lastUpdated.textContent = new Date(cached.t).toLocaleString();
  }

  // Currency change handling: convert current money fields
  function convertCurrencyFields(to){
    const from = (to === 'JPY') ? 'USD' : 'JPY';
    if (!isFinite(fxUSDJPY)) return;
    const rate = fxUSDJPY;
    const fieldsToConvert = [spot, shop]; // monetary inputs
    fieldsToConvert.forEach(el => {
      const v = parseNum(el);
      if (!isFinite(v)) return;
      let newVal;
      if (to === 'JPY' && from === 'USD') newVal = v * rate;
      else if (to === 'USD' && from === 'JPY') newVal = v / rate;
      else newVal = v;
      el.value = (to === 'JPY') ? Math.round(newVal).toString() : (Math.round(newVal*100)/100).toString();
    });
    updateDerived18k();
    updateCalc();
  }

  // Wire events
  ['input','change'].forEach(ev=>{
    [weight, karat, karatCustom, spot, shop, inclTax, tax].forEach(el=> el.addEventListener(ev, ()=>{ save(); updateCalc(); }));
  });
  currency.addEventListener('change', async ()=>{
    save();
    // ensure fx loaded
    if (!isFinite(fxUSDJPY)) await fetchFX();
    convertCurrencyFields(currency.value);
    save();
  });
  autoSpot.addEventListener('change', ()=>{ save(); updateSpotFromInternet(false); });
  refreshBtn.addEventListener('click', ()=>{ updateSpotFromInternet(true); });

  // Init: load state, then ensure fx+spot (maybe cached), then calc
  load();
  if(!weight.value) weight.value = '12.4';
  if(!shop.value) shop.value = (currency.value==='JPY' ? '198000' : '1298');
  if(!tax.value) tax.value = '0.10';
  updateCalc();
  // Preload FX & spot
  fetchFX().then(()=> updateSpotFromInternet(false));

})();</script>
</body>
</html>
